<script>

// Load native UI library
var gui = require('nw.gui');
var states = require('./states');

require('./server');

// gui.Window.get().showDevTools();

var currentIndex = 0;

// Create a tray icon
var tray = new gui.Tray({
  icon: states[0].icon,
  iconsAreTemplates: false,
  // click: function () {
  //   tray.icon = states[currentIndex].icon;
  //   currentIndex = currentIndex >= states.length - 1 ? 0 : currentIndex + 1;
  // }
});

// Give it a menu
var menu = new gui.Menu();
menu.append(new gui.MenuItem({
  label: states[0].label,
  click: function() {
    global.setState();
  },
}));
menu.append(new gui.MenuItem({ type: 'separator' }));
menu.append(new gui.MenuItem({
  label: 'Quit',
  click: function() {
    tray.remove();
    tray = null;
    gui.App.quit();
  }
}));
tray.menu = menu;

function getIndex (state) {
  var index;
  states.forEach(function (el, i) {
    if (el.phase === state) index = i;
  });
  return index;
}

global.setState = function(state){
  if (typeof state !== 'undefined') {
    currentIndex = getIndex(state);
  } else {
    currentIndex = currentIndex >= 2 ? 0 : currentIndex + 1;
  }
  tray.icon = states[currentIndex].icon;
  menu.items[0].label = states[currentIndex].label;
};

global.getState = function () {
  return states[currentIndex];
};

</script>
